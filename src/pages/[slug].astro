---
import Layout from '../layouts/Layout.astro';
import RelatedTools from '../components/RelatedTools.astro';
import fs from 'node:fs/promises';
import path from 'node:path';

export async function getStaticPaths() {
  const registryPath = path.resolve('tools/registry.json');
  const registryData = await fs.readFile(registryPath, 'utf-8');
  const registry = JSON.parse(registryData);

  const activeRegistry = registry.filter((entry: any) => entry.status === 'active');
  const paths = await Promise.all(activeRegistry.map(async (entry: any) => {
    const defPath = path.resolve(`tools/definitions/${entry.slug}.json`);
    const defData = await fs.readFile(defPath, 'utf-8');
    const definition = JSON.parse(defData);

    let nextDecisionData = null;
    let upstreamDecisionData = null;

    if (definition.nextDecision) {
        try {
            const ndPath = path.resolve(`tools/definitions/${definition.nextDecision}.json`);
            nextDecisionData = { slug: definition.nextDecision, title: JSON.parse(await fs.readFile(ndPath, 'utf-8')).title };
        } catch(e) {}
    }

    if (definition.upstreamDecision) {
        try {
            const udPath = path.resolve(`tools/definitions/${definition.upstreamDecision}.json`);
            upstreamDecisionData = { slug: definition.upstreamDecision, title: JSON.parse(await fs.readFile(udPath, 'utf-8')).title };
        } catch(e) {}
    }

    return {
      params: { slug: entry.slug },
      props: { tool: entry, definition, nextDecisionData, upstreamDecisionData }
    };
  }));

  return paths;
}

const { tool, definition, nextDecisionData, upstreamDecisionData } = Astro.props;

// Generate Meta Tags
const metaTitle = `${definition.title} â€“ Econified`;
const metaDescription = `${definition.description} Configurable calculation to estimate your ${definition.outputs[0]?.label.toLowerCase() || 'result'}.`;

// Generate JSON-LD Schema
const schemaData = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "SoftwareApplication",
      "name": definition.title,
      "applicationCategory": "CalculatorApplication",
      "operatingSystem": "All",
      "description": definition.description,
      "offers": { "@type": "Offer", "price": "0" }
    },
    {
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Home",
          "item": "https://econified.com/"
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": definition.title,
          "item": `https://econified.com/${tool.slug}/`
        }
      ]
    },
    ...(definition.faqs?.length > 0 ? [{
      "@type": "FAQPage",
      "mainEntity": definition.faqs.map((faq: any) => ({
        "@type": "Question",
        "name": faq.q,
        "acceptedAnswer": {
          "@type": "Answer",
          "text": faq.a
        }
      }))
    }] : [])
  ]
};
const canonicalUrl = `https://econified.com/${tool.slug}/`;
---

<Layout title={metaTitle} description={metaDescription} canonicalUrl={canonicalUrl}>
  <script type="application/ld+json" set:html={JSON.stringify(schemaData)} />
  <script data-domain="econified.com" src="https://plausible.io/js/script.js" defer></script>
  
  <main class="container">
    <nav class="breadcrumb" style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">
      <a href="/" style="color: inherit;">Home</a> &rsaquo; {definition.title}
    </nav>
    <div class="tool-header" style="margin-bottom: 1.5rem;">
      <h1 style="margin-bottom: 0.5rem;">{definition.title}</h1>
      <div class="freshness-signal" style="font-size: 0.85rem; color: var(--text-secondary); display: flex; align-items: center; gap: 0.5rem;">
        <span aria-hidden="true">&#x1F5D2;&#xFE0F;</span> Last Updated: <time datetime={tool.updatedAt}>{new Date(tool.updatedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</time>
      </div>
    </div>
    <p class="lead">{definition.description}</p>

    <div class="capability-block" role="list">
       <span class="badge" role="listitem"><strong>What this tool does:</strong> {definition.description}</span>
       <span class="badge" role="listitem"><strong>Inputs:</strong> {definition.inputs.map((i:any)=>i.label).join(', ')}</span>
       <span class="badge" role="listitem"><strong>Outputs:</strong> {definition.outputs.map((o:any)=>o.label).join(', ')}</span>
       <span class="badge" role="listitem"><strong>Processing:</strong> Runs locally in your browser</span>
       <span class="badge" role="listitem"><strong>Privacy:</strong> No inputs stored or sent</span>
    </div>

    <!-- Explicit AEO Use Cases -->
    <div class="use-cases-block" style="margin-bottom: 2rem; padding: 1rem; background: rgba(30, 41, 59, 0.4); border-radius: 6px; border-left: 3px solid var(--primary-light);">
      <h3 style="margin-top: 0; margin-bottom: 0.5rem; font-size: 1rem; color: var(--text-primary);">When to use this tool:</h3>
      <ul style="margin: 0; padding-left: 1.5rem; color: var(--text-secondary); font-size: 0.95rem;">
        {definition.useCases.map((useCase: string) => <li>{useCase}</li>)}
      </ul>
    </div>

    {tool.adPolicy === 'highIntent' && (
      <div class="ad-slot leaderboard" aria-hidden="true">Reserved Ad Space (Leaderboard)</div>
    )}

    <!-- Calculator Interface -->
    <div class="glass-panel" id="calculator-app" aria-live="polite">
      <form id="calc-form" data-engine={tool.engine} data-fn={tool.slug}>
        {definition.inputs.map((input: any) => (
          <div class="input-group">
            <label for={input.name} id={`label-${input.name}`}>{input.label}</label>
            <input 
              type="number" 
              id={input.name} 
              name={input.name} 
              value={tool.defaults[input.name] || ''} 
              required
              aria-labelledby={`label-${input.name}`}
              min={input.min !== undefined ? input.min : "0"}
              max={input.max !== undefined ? input.max : undefined}
              step={input.step !== undefined ? input.step : "any"}
              placeholder={input.placeholder || `Enter ${input.label.toLowerCase()}`}
            />
          </div>
        ))}
      </form>

      <div class="outputs" aria-atomic="true">
        {definition.outputs.map((output: any) => (
          <div class="result-card">
            <div class="label" id={`label-out-${output.name}`}>{output.label}</div>
            <div class="result-value" id={`out-${output.name}`} data-unit={output.unit} aria-labelledby={`label-out-${output.name}`}>-</div>
          </div>
        ))}
      </div>
    </div>

    {(tool.adPolicy === 'highIntent' || tool.adPolicy === 'standard' || tool.adPolicy === 'compareIntent') && (
      <div class="ad-slot rectangle" aria-hidden="true">Reserved Ad Space (Rectangle)</div>
    )}

    <div class="content-section">
      <h2>How it's Calculated</h2>
      <ul class="insights-list">
        {definition.methodSummary.map((method: string) => <li>{method}</li>)}
      </ul>

      <h2>Key Assumptions</h2>
      <ul class="insights-list">
        {definition.assumptions.map((assumption: string) => <li>{assumption}</li>)}
      </ul>

      <h2>Actionable Insights</h2>
      <ul class="insights-list">
        {definition.insights.map((insight: string) => <li>{insight}</li>)}
      </ul>

      <h2>Frequently Asked Questions</h2>
      <div class="faq-list">
        {definition.faqs.map((faq: any) => (
          <div class="faq-item">
            <strong>{faq.q}</strong>
            <p>{faq.a}</p>
          </div>
        ))}
      </div>
    </div>

    <!-- The Decision Graph -->
    {(nextDecisionData || upstreamDecisionData) && (
      <nav class="decision-graph" aria-label="Decision Pathway" style="margin-top: 4rem; display: flex; flex-wrap: wrap; gap: 1rem; justify-content: space-between; border-top: 1px solid var(--surface-border); padding-top: 2rem;">
        {upstreamDecisionData ? (
          <a href={`/${upstreamDecisionData.slug}/`} class="glass-panel" data-analytics="decision-upstream" style="flex: 1; min-width: 250px; text-decoration: none;">
            <span style="font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em;">&larr; Previous Step</span>
            <strong style="display: block; margin-top: 0.25rem; color: var(--text-primary);">{upstreamDecisionData.title}</strong>
          </a>
        ) : <div style="flex: 1; min-width: 250px;"></div>}
        
        {nextDecisionData && (
          <a href={`/${nextDecisionData.slug}/`} class="glass-panel" data-analytics="decision-next" style="flex: 1; min-width: 250px; text-decoration: none; text-align: right;">
            <span style="font-size: 0.8rem; color: var(--primary-light); text-transform: uppercase; letter-spacing: 0.05em;">Next Step &rarr;</span>
            <strong style="display: block; margin-top: 0.25rem; color: var(--text-primary);">{nextDecisionData.title}</strong>
          </a>
        )}
      </nav>
    )}
    
    <RelatedTools currentSlug={tool.slug} clusters={definition.clusters || []} />
  </main>

  <script>
    import { engineMap } from '../utils/engineMap.ts';

    // Simple tracking integration (Plausible)
    function trackEvent(eventName: string, props = {}) {
        if (typeof window !== 'undefined' && (window as any).plausible) {
            (window as any).plausible(eventName, { props });
        }
    }

    const form = document.getElementById('calc-form');
    if (form) {
      const inputs = Array.from(form.querySelectorAll('input'));
      const slug = form.dataset.fn || '';

      let interactionCount = 0;

      function calculate() {
        const values: Record<string, number> = {};
        inputs.forEach(input => {
          values[input.name] = parseFloat(input.value) || 0;
        });

        // 1. Fetch proper engine function from dictionary
        const calcFn = engineMap[slug];
        if (!calcFn) {
            console.error(`Missing engine map for tool: ${slug}`);
            return;
        }

        // 2. Compute results purely
        const results = calcFn(values);

        // 3. Apply formatting & update DOM
        Object.entries(results).forEach(([key, val]) => {
          const el = document.getElementById(`out-${key}`);
          if (el) {
            if (el.dataset.unit === 'percent') {
              el.textContent = (val > 0 ? '+' : '') + val.toFixed(1) + '%';
            } else {
              el.textContent = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val);
            }
          }
        });

        interactionCount++;
        // Track the first user-driven calculation per session/page-load to avoid spam
        if(interactionCount === 2) { 
           trackEvent('calculation_run', { tool: slug });
        }
      }

      // Initial calculation
      calculate();
      trackEvent('tool_loaded', { tool: slug });

      // Listen for changes
      inputs.forEach(input => {
        input.addEventListener('input', calculate);
      });

      // Track related tool clicks
      const relatedLinks = Array.from(document.querySelectorAll('[data-analytics="related-tool-click"]'));
      relatedLinks.forEach(link => {
          link.addEventListener('click', () => {
              trackEvent('related_tool_clicked', { source_tool: slug, target: link.getAttribute('href') });
          });
      });
    }
  </script>
</Layout>
